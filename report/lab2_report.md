
# Stage1
## åŒ¹é…è±†ç“£IDä¸FreeBaseå®ä½“
è¯»å–ç»™å®šçš„ `douban2fb.txt` æ–‡ä»¶ï¼Œè·å¾—è±†ç“£IDå¯¹åº”çš„midï¼Œå¹¶æ·»åŠ å‰ç¼€ä½¿ä¹‹ä¸ç»™å®šçš„ `freebase_douban.gz` ä¸­å®ä½“æ ¼å¼ä¸€è‡´ï¼Œè¿”å›dictå‹çš„æ˜ å°„è¡¨ä¸setå‹çš„ç»™å®šç”µå½±å®ä½“ï¼š

```python
def readMap():
    '''
    return Map (dict,{id:fb}) and movie_entity list
    '''
    with open('data/douban2fb.txt', 'r') as file:
        data = file.readlines()

    Map = {}
    movie_entity = []
    for line in data:
        temp = line.split()
        Map[temp[0]] = '<'+'http://rdf.freebase.com/ns/' + temp[1] +'>'
        movie_entity.append('<'+'http://rdf.freebase.com/ns/' + temp[1] +'>')
    return Map, set(movie_entity)
```

## ç¬¬ä¸€æ­¥ç­›é€‰
ç”¨ä¸Šé¢çš„ `readMap` æ–¹æ³•å¾—åˆ°ç»™å®šçš„ç”µå½±å®ä½“è¡¨ï¼Œéå†ç»™å®šçš„çŸ¥è¯†å›¾è°±ï¼Œé‡åˆ°å¤´å®ä½“æˆ–å°¾å®ä½“æ˜¯ç»™å®šç”µå½±æ—¶ï¼Œå°†å…¶å†™å…¥ `KG_1step.txt` ä¸­ã€‚

éå†ç»“æŸåï¼Œç»Ÿè®¡å®ä½“å’Œå…³ç³»å‡ºç°æ•°é‡ï¼ŒæŒ‘é€‰é«˜é¢‘å®ä½“ï¼Œå­˜å…¥ `entity_1step.txt` ä¸­ã€‚ç»™å®šå®ä½“çš„é¢‘æ•°åˆå§‹å€¼ä¸ºç­›é€‰çš„æœ€ä½æ ‡å‡†ï¼Œä¿è¯ç»™å®šå®ä½“ä¸è¢«ç­›èµ°ï¼š

```python
    _, given_movie = readMap()
    for movie in given_movie:
        entity_count[movie] = min_entity
```

è¿™äº›txtæ–‡ä»¶ï¼Œä»¥åŠä¸‹æ–‡æåˆ°çš„ä¸€äº›txtæ–‡ä»¶éƒ½æ²¡æœ‰æäº¤ï¼Œä½†è¿è¡Œ lab2/stage1/buildTriplet.py æ–‡ä»¶æ—¶ä¼šç”Ÿæˆæåˆ°çš„æ‰€æœ‰txtã€‚

## ç¬¬äºŒæ­¥ç­›é€‰
è¯»å–ç¬¬ä¸€æ­¥ `entity_1step.txt` ä¸­çš„æ‹“å±•å®ä½“è¡¨ï¼Œéå†çŸ¥è¯†å›¾è°±ï¼Œæ‰¾åˆ°æ‰€æœ‰å¤´å®ä½“æˆ–å°¾å®ä½“æ˜¯æ‹“å±•å®ä½“çš„ä¸‰å…ƒç»„ï¼Œå†™å…¥ `KG_2step.gz` ä¸­ï¼Œæœ€ç»ˆå¾—åˆ°çš„ `KG_2step.gz` çº¦1.4Gã€‚ç»Ÿè®¡å…¶ä¸­å®ä½“å’Œå…³ç³»çš„å‡ºç°æ¬¡æ•°ã€‚

åœ¨ `KG_2step.gz` ä¸­ï¼ŒæŒ‘é€‰å¤´å®ä½“ã€å°¾å®ä½“ã€å…³ç³»å‡ä¸ºé«˜é¢‘çš„ä¸‰å…ƒç»„ï¼Œå†™å…¥ `KG_2step_filtered.txt` ä¸­ï¼Œæœ€ç»ˆå¾—åˆ°çš„å›¾è°±å¤§çº¦æœ‰ 50w ä¸ªä¸‰å…ƒç»„:

```python
    def eligible_entity(e):
        if entity_count[e] > 20 and entity_count[e] < max_entity:
            return True
        else:
            return False

    triplet = line.decode().split('\t')[:3]
    if relation_count[triplet[1]] > min_relation 
        and eligible_entity(triplet[0]) 
        and eligible_entity(triplet[2]):
            output.write(' '.join(triplet) + '\n')
```

## ç­›é€‰æ ‡å‡†çš„ç¡®å®š
æœ€ç»ˆå¾—åˆ°çš„çŸ¥è¯†å›¾è°±æ˜¾ç„¶å·²ç»è¶…è¿‡äº†ç¾¤é‡Œè¯´çš„ 5w ä¸ªä¸‰å…ƒç»„ï¼Œå› æ­¤ç»Ÿè®¡äº†ä¸€ä¸‹ä¸åŒè¦æ±‚ä¸‹ï¼Œç¬¦åˆæ¡ä»¶çš„å®ä½“å’Œå…³ç³»æ•°é‡ï¼Œè¿™éƒ¨åˆ†ä»£ç åœ¨ `draft.py` ä¸­ã€‚

![](assert2/Screenshot%202023-12-24%20220645.png)

ä¸Šå›¾å¯ä»¥çœ‹åˆ°å‡ºç°è¶…è¿‡ 50 æ¬¡çš„å…³ç³»æœ‰ 403 æ¡ï¼Œå‡ºç°è¶…è¿‡ 40 æ¬¡çš„å®ä½“æœ‰ 21911 ä¸ªï¼Œä»¥æ­¤ä¸ºæ ‡å‡†ç­›é€‰å‡ºçš„å›¾è°±å¤§çº¦æœ‰ 30w ä¸ªä¸‰å…ƒç»„ï¼Œå·²ç»æœ‰äº›å¤šäº†ã€‚è€Œä¸”å®é™…è¿è¡Œåï¼Œå‘ç°ä»¥ 40 ä¸ºæ ‡å‡†ä¼šå°†ä¸¤ä¸ªç»™å®šç”µå½±ç­›æ‰ï¼š

![](assert2/QQå›¾ç‰‡20231224221026.png)

ä¸¤éƒ¨ç”µå½±åˆ†åˆ«æ˜¯ [æƒ…ä¹¦](https://movie.douban.com/subject/1292220) å’Œ [ä½ ä¸«é—­å˜´ï¼](https://movie.douban.com/subject/1303815)ï¼Œè¿™ä¸¤éƒ¨ç”µå½±è‡ªèº«çš„å‡ºç°æ¬¡æ•°éƒ½æœ‰å¥½å‡ ç™¾æ¬¡ï¼Œä½†æ˜¯æ²¡æœ‰é“¾æ¥åˆ°å…¶ä»–é«˜é¢‘å®ä½“ä¸Šå»ï¼Œå› æ­¤æœ€ç»ˆçš„çŸ¥è¯†å›¾è°±ä¸­æ²¡æœ‰ä»–ä»¬ã€‚

å°†å®ä½“çš„é¢‘æ•°è¦æ±‚é™ä½åˆ° 20 ä»¥ä¸Šï¼Œç¬¦åˆè¦æ±‚çš„å®ä½“å’Œå…³ç³»æ•°å¦‚ä¸‹ï¼š

![](assert2/Screenshot%202023-12-24%20221555.png)

ç¬¦åˆè¦æ±‚çš„å®ä½“å¤šäº†å¾ˆå¤šï¼Œè¿‡æ»¤åçš„çŸ¥è¯†å›¾è°±è§„æ¨¡ä¹Ÿè¾¾åˆ°äº† 50w ä¸ªä¸‰å…ƒç»„ï¼Œå³ä½¿å¦‚æ­¤ã€Šä½ ä¸«é—­å˜´ï¼ã€‹é“¾æ¥åˆ°çš„å®ä½“ä¾ç„¶å¾ˆå°‘ï¼Œã€Šæƒ…ä¹¦ã€‹åˆ™å¤šä¸€äº›ï¼š

![](assert2/Screenshot%202023-12-24%20221748.png)

![](assert2/Screenshot%202023-12-24%20221840.png)

![](assert2/Screenshot%202023-12-24%20221958.png)

![](assert2/Screenshot%202023-12-24%20222025.png)

![](assert2/Screenshot%202023-12-24%20222107.png)

æœ€ç»ˆé€‰æ‹©äº† 50w ä¸ªä¸‰å…ƒç»„çš„è§„æ¨¡ï¼Œéå†ä¸€æ¬¡éœ€è¦ä¸åˆ° 1 ç§’ï¼ŒåŒ…å«äº†ç»™å®šçš„å…¨éƒ¨å®ä½“ï¼Œä½†å¯èƒ½ä¾ç„¶ä¸è¶³ä»¥æ”¯æ’‘å®é™…çš„æ¨èä»»åŠ¡ã€‚

# Stage2
## å®ä½“ä¸å…³ç³»åˆ°IDçš„æ˜ å°„
è¯»å–ç»™å®šçš„ `movie_id_map.txt` ä¸­è±†ç“£IDåˆ°å®éªŒIDçš„æ˜ å°„ï¼Œç»“åˆStage1ä¸­å¾—åˆ°çš„è±†ç“£IDåˆ°Freebaseå®ä½“çš„æ˜ å°„ï¼Œå¾—åˆ°Freebaseå®ä½“åˆ°å®éªŒIDçš„æ˜ å°„ï¼š

```python
    with open('data/movie_id_map.txt', 'r') as file:
        data = file.readlines()

    fb_to_id = {}
    for line in data:
        # temp[0] = db, temp[1] = id
        temp = line.split()
        fb = db_to_fb[temp[0]]
        fb_to_id[fb] = temp[1]
```

ç»™å®šç”µå½±æ˜ å°„å®Œæ¯•åï¼Œéå†Stage1å¾—åˆ°çš„ `KG_2step_filtered.txt`ï¼Œå¾—åˆ°å…¶ä¸­æ‰€æœ‰çš„å…³ç³»å’Œå®ä½“é›†åˆï¼Œå°†ä¸åœ¨ç»™å®šç”µå½±ä¸­çš„å®ä½“ä»578å¼€å§‹ç¼–å·ï¼Œå¹¶å°†å…³ç³»æ˜ å°„åˆ°[0, ğ‘›ğ‘¢ğ‘š ğ‘œğ‘“ ğ‘Ÿğ‘’ğ‘™ğ‘ğ‘¡ğ‘–ğ‘œğ‘›ğ‘ )èŒƒå›´ã€‚

